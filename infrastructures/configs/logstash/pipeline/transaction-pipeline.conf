input {
  beats {
    port => 5044
    host => "0.0.0.0"
  }

  # For future use: TCP input for custom transaction data
  tcp {
    port => 5000
    codec => json
  }
}

filter {
  # Parse transaction data
  if [message] =~ /transaction/ {
    json {
      source => "message"
      target => "transaction"
    }
  }

  # Add timestamp if not present
  if ![timestamp_ms] {
    ruby {
      code => "event.set('timestamp_ms', (Time.now.to_f * 1000).to_i)"
    }
  }

  # Convert timestamp to date
  date {
    match => [ "timestamp_ms", "UNIX_MS" ]
    target => "@timestamp"
  }

  # Add tags for easier filtering
  if [transaction][execution_status] {
    mutate {
      add_tag => [ "sui_transaction" ]
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["${ELASTICSEARCH_URL}"]
    index => "sui-transactions-%{+YYYY.MM.dd}"
    document_id => "%{[transaction][tx_digest]}"
  }

  # For debugging - comment out in production
  stdout {
    codec => rubydebug
  }
}
